# Caddyfile for Propofol Dreams Flutter Web App
# This configuration serves the Flutter web app from the Docker volume

# Replace 'your-domain.com' with your actual domain
# For local testing, you can use 'localhost' or 'localhost:8080'
app.propofoldreams.org {
    # Serve static files from the Docker volume
    # This path should match the volume mount in your Caddy container
    root * /srv

    # Enable file server for static assets
    file_server

    # Enable compression for better performance
    encode {
        gzip 6
        zstd
        minimum_length 1024
    }

    # Security headers for web applications
    header {
        # Prevent MIME type sniffing
        X-Content-Type-Options nosniff

        # Prevent clickjacking attacks
        X-Frame-Options DENY

        # Control referrer information
        Referrer-Policy strict-origin-when-cross-origin

        # Enable XSS protection
        X-XSS-Protection "1; mode=block"

        # Content Security Policy (adjust as needed for your app)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'none';"
    }

    # Cache static assets for better performance
    @static {
        file
        path *.js *.css *.woff *.woff2 *.ttf *.eot *.ico *.png *.jpg *.jpeg *.gif *.svg *.webp
    }
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # Cache HTML files for shorter duration
    @html {
        file
        path *.html
    }
    header @html {
        Cache-Control "public, max-age=3600"
    }

    # Handle Flutter routing - serve index.html for all routes
    # This is essential for Flutter web apps with client-side routing
    try_files {path} /index.html

    # Optional: Add basic logging
    log {
        output file /var/log/caddy/propofol-dreams.log
        format json
    }

    # Optional: Rate limiting to prevent abuse
    rate_limit {
        zone static {
            key {remote_host}
            events 100
            window 1m
        }
    }
}

# Alternative configuration for local development/testing
# Uncomment the section below if you want to test locally
# localhost, localhost:8080 {
#     root * /srv
#     file_server
#     encode gzip zstd
#     try_files {path} /index.html
#
#     # Less strict headers for development
#     header {
#         X-Content-Type-Options nosniff
#         X-Frame-Options SAMEORIGIN
#     }
# }

# HTTP to HTTPS redirect (automatic with domain)
# Caddy automatically handles HTTPS certificates for domains